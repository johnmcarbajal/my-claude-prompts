#!/bin/bash
# gleam-expert - Activate the Gleam development expert agent
# Usage: gleam-expert [--skip-analysis]

set -euo pipefail

PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
GLEAM_CONTEXT_DIR="${PROJECT_ROOT}/.gleam_context"

echo "ðŸ¦€âœ¨ Activating Gleam Expert Agent..."

# Check for handoff context
if [[ -f ".gleam_handoff.json" ]]; then
    echo "ðŸ’¥ Processing handoff from coordinator"
    HANDOFF_CONTEXT=$(cat .gleam_handoff.json)
    echo "Context: $(echo "$HANDOFF_CONTEXT" | jq -r '.context_message // "No message"')"
    echo "---"
fi

# Create agent status file
mkdir -p "${GLEAM_CONTEXT_DIR}/active"
cat > "${GLEAM_CONTEXT_DIR}/active/gleam-expert.json" <<EOF
{
  "agent": "gleam-expert",
  "activated_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "project_root": "$PROJECT_ROOT",
  "mode": "development"
}
EOF

# Skip analysis if requested
if [[ "${1:-}" == "--skip-analysis" ]]; then
    echo "â© Skipping initial analysis"
    echo "ðŸŽ¯ Gleam Expert ready for development tasks"
    exit 0
fi

# Execute the mandatory activation protocol from the expert specification
echo "âœ¨ Analyzing Gleam project state..."

# Check git status
echo "ðŸ“Š Git repository status:"
git status --porcelain || echo "Not in a git repository"
echo ""

# Analyze recent changes with focus on Gleam patterns
echo "ðŸ” Gleam code analysis:"
if git log --oneline -5 >/dev/null 2>&1; then
    git log --oneline -5
    echo ""
    
    # Look for Gleam files in recent changes
    echo "ðŸ“ Recent Gleam file changes:"
    git diff --name-status HEAD~5..HEAD 2>/dev/null | while read status file; do
        case "$file" in
            gleam.toml)
                echo "ðŸ“¦ MANIFEST: $status $file"
                ;;
            *.gleam)
                echo "âœ¨ GLEAM_CODE: $status $file"
                # Check for functional pattern concerns in the file
                if git show "HEAD:$file" 2>/dev/null | grep -q "panic\|todo\|assert"; then
                    echo "   âš ï¸  PANIC_PRONE: Contains panic/todo/assert patterns"
                fi
                if git show "HEAD:$file" 2>/dev/null | grep -q "case.*_"; then
                    echo "   ðŸ” PATTERN_MATCHING: Catch-all patterns detected"
                fi
                ;;
            test/*|*_test.gleam)
                echo "ðŸ§ª TEST: $status $file"
                ;;
            *config*|*.toml|*.json)
                echo "âš™ï¸ CONFIG: $status $file"
                ;;
        esac
    done
else
    echo "No git history available"
fi
echo ""

# Critical functional safety analysis
echo "ðŸš¨ Functional safety scan:"
if git diff HEAD~3..HEAD -- "*.gleam" 2>/dev/null | grep -n -E "(panic|todo\(\)|assert)"; then
    echo "âš ï¸  PANIC-PRONE CODE DETECTED - NEEDS ATTENTION"
else
    echo "âœ… No panic-prone patterns detected"
fi

if git diff HEAD~3..HEAD -- "*.gleam" 2>/dev/null | grep -E "(case.*_|let.*=.*case)"; then
    echo "âš ï¸  PATTERN MATCHING COMPLEXITY - REVIEW FOR EXHAUSTIVENESS"
else
    echo "âœ… No complex pattern matching detected"
fi

if git diff HEAD~3..HEAD -- "*.gleam" 2>/dev/null | grep -E "Error\(.*\)|Ok\(.*\)"; then
    echo "âœ… Result type usage detected - good error handling patterns"
fi
echo ""

# Actor model integrity check
echo "ðŸŽ­ Actor model analysis:"
if git diff HEAD~3..HEAD -- "*.gleam" 2>/dev/null | grep -E "(actor\.|Subject\(|process\.)"; then
    echo "ðŸ“¡ ACTOR PATTERNS DETECTED"
    if git diff HEAD~3..HEAD -- "*.gleam" 2>/dev/null | grep -E "(actor\.call|actor\.send)"; then
        echo "   ðŸ“ž Message passing patterns found"
    fi
    if git diff HEAD~3..HEAD -- "*.gleam" 2>/dev/null | grep -E "(supervisor|start_link)"; then
        echo "   ðŸŒ³ Supervision tree patterns found"
    fi
else
    echo "â„¹ï¸ No actor model patterns detected"
fi
echo ""

# Dependency analysis
echo "ðŸ“¦ Dependency analysis:"
if [[ -f "gleam.toml" ]]; then
    echo "âœ… Gleam project detected"
    if git diff HEAD~3..HEAD gleam.toml 2>/dev/null | grep "^\+"; then
        echo "ðŸ“‹ New dependencies added:"
        git diff HEAD~3..HEAD gleam.toml | grep "^\+" | grep -v "^\+++" | sed 's/^\+//' | head -5
        echo "âš ï¸  FUNCTIONAL PATTERN REVIEW REQUIRED for new dependencies"
    else
        echo "âœ… No new dependencies"
    fi
else
    echo "âŒ No gleam.toml found - not a Gleam project"
fi
echo ""

# Show recent code changes for development context
echo "ðŸ“Š Recent code changes for development:"
if git diff --unified=3 HEAD~3..HEAD -- "*.gleam" >/dev/null 2>&1; then
    git diff --unified=3 HEAD~3..HEAD -- "*.gleam" | head -50
    if [[ $(git diff HEAD~3..HEAD -- "*.gleam" | wc -l) -gt 50 ]]; then
        echo "... (truncated - large changeset detected)"
    fi
else
    echo "No recent Gleam code changes"
fi
echo ""

echo "ðŸŽ¯ Gleam Expert Agent ready for:"
echo "   â€¢ Architecture design and planning"
echo "   â€¢ New Gleam code implementation"
echo "   â€¢ Functional pattern development"
echo "   â€¢ Actor model design"
echo "   â€¢ Type system architecture"
echo "   â€¢ Teaching and explanation"
echo ""
echo "ðŸ’¡ Ready to build, teach, and architect!"
